generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Service {
  id         Int      @id @default(autoincrement())
  name       String   @unique
  url        String
  authHeader String?
  provider   String?
  createdAt  DateTime @default(now())

  metrics   Metric[]
  deploys   DeployEvent[]
  anomalies Anomaly[]
  logs LogEvent[]
}

model Anomaly {
  id        Int      @id @default(autoincrement())
  serviceId Int
  metric    String
  value     Float
  baseline  Float
  severity  Float
  timestamp DateTime @default(now())

  service Service         @relation(fields: [serviceId], references: [id])
  causes  AnomalyCause[]
}

model Metric {
  id        Int      @id @default(autoincrement())
  serviceId Int
  cpu       Float
  memory    Float
  latency   Float
  errorRate Float
  timestamp DateTime @default(now())

  service Service @relation(fields: [serviceId], references: [id])
}

model DeployEvent {
  id        Int      @id @default(autoincrement())
  serviceId Int
  version   String
  timestamp DateTime

  service Service         @relation(fields: [serviceId], references: [id])
  causes  AnomalyCause[]
  logs LogEvent[]
}

model AnomalyCause {
  id         Int      @id @default(autoincrement())
  anomalyId  Int
  deployId   Int
  confidence Float
  reason     String
  createdAt  DateTime @default(now())

  anomaly     Anomaly     @relation(fields: [anomalyId], references: [id])
  deployEvent DeployEvent @relation(fields: [deployId], references: [id])
}

model LogEvent {
  id         Int      @id @default(autoincrement())

  // ownership
  serviceId Int
  deployId  Int?

  // cloud / platform
  provider  String   // vercel | aws | azure | gcp | k8s
  source    String   // runtime | build | deploy | infra

  // classification
  level     String   // info | warn | error | fatal | debug
  message   String

  // tracing / request linking
  traceId   String?
  requestId String?

  // time
  timestamp DateTime

  // raw provider payload
  raw       Json?

  createdAt DateTime @default(now())

  service Service @relation(fields: [serviceId], references: [id])
  deploy  DeployEvent? @relation(fields: [deployId], references: [id])

  @@index([serviceId, timestamp])
  @@index([deployId])
  @@index([level])
  @@index([traceId])
  @@index([provider, source])
}
